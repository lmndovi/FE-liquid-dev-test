{% comment %}
  Product Cards Grid
  Mobile: Stacked vertically
  Desktop: Side-by-side (2 columns)
{% endcomment %}

<div class="product-grid flex flex-col md:grid md:grid-cols-2 gap-6 p-6 md:pt-[80px] md:pb-[48px] md:pl-[420px] md:pr-[420px] md:gap-6">
  {% for product in collection.products %}
    <article class="product-card" aria-labelledby="product-{{ product.id }}-title">
  <!-- Image Wrapper -->
      <a href="{{ product.url | default: '#' }}" class="product-card__image-wrapper" aria-label="View {{ product.title }}">
        {% assign product_image = product.media[0].preview_image.src | default: product.featured_image %}
        {% assign product_alt = product.media[0].alt | default: product.title %}
        {% if product_image %}
          <figure>
            <img src="{{ product_image }}" alt="{{ product_alt }}" class="product-card__img" loading="lazy">
          </figure>
        {% else %}
          <figure>
            <div class="product-card__img-placeholder" aria-label="{{ product_alt }}"></div>
          </figure>
        {% endif %}
        
        {% if product.tags contains 'Best Seller' %}
          <div class="tag-pill">Bestseller</div>
        {% endif %}
        
        <div class="carousel-dots">
          {% for media in product.media %}
            <span class="carousel-dot {% if forloop.first %}carousel-dot--active{% endif %}"></span>
          {% endfor %}
        </div>
      </a>

<!-- Info -->
      <div class="product-card__info flex flex-col gap-4">
        <div class="flex flex-col gap-2">
          <h3 id="product-{{ product.id }}-title" class="text-base font-semibold leading-[21px] text-[#09121F]">{{ product.title }}</h3>
          {% assign product_excerpt = product.metafields.custom.product_excerpt.value | default: product.content | strip_html%}
          <p class="text-sm leading-[18px] text-[#09121F]">{{ product_excerpt }}</p>
        </div>

        <!-- Price -->
        <div class="flex flex-row items-center gap-2">
          {% assign current_price = product.price %}
          {% assign compare_price = product.compare_at_price %}
          {% assign is_on_sale = compare_price and compare_price > current_price %}
          
          {% if is_on_sale %}
            {% assign saving = compare_price | minus: current_price %}
            <span class="text-xl leading-[26px] text-[#09121F]">{{ current_price | money }}</span>
            <span class="price-tag price-tag--was">Was {{ compare_price | money }}</span>
            <span class="price-tag price-tag--save">Save {{ saving | money }}</span>
          {% else %}
            <span class="text-xl leading-[26px] text-[#09121F]">{{ current_price | money }}</span>
          {% endif %}
        </div>

        <!-- Nutrition -->
        <div class="product-card__nutrition flex flex-row items-center gap-2">
        {% assign protein = '' %}
        {% assign low_calories = false %}
        {% assign low_sugar = false %}
        
        {% comment %}
          LiquidJS stores metafields as an array, so we loop and match by 'key'
          instead of using dot notation (product.metafields.custom.protein_per_serving.value)
        {% endcomment %}


        {% for metafield in product.metafields %}
          {% if metafield.key == 'protein_per_serving' %}
            {% assign protein = metafield.value %}
          {% endif %}
          {% if metafield.key == 'low_calories' %}
            {% assign low_calories = metafield.value %}
          {% endif %}
          {% if metafield.key == 'low_sugar' %}
            {% assign low_sugar = metafield.value %}
          {% endif %}
        {% endfor %}
        
        {% if protein != '' %}
          <span>{{ protein }} Protein</span>
        {% endif %}
        {% if low_calories %}
          <span class="nutrition-dot"></span>
          <span>Low Calories</span>
        {% endif %}
        {% if low_sugar %}
          <span class="nutrition-dot"></span>
          <span>Low Sugar</span>
        {% endif %}
        </div>

        <!-- CTA -->
        <div class="cta-container flex flex-row items-start gap-2">
          <div class="quantity-selector flex flex-row items-center" role="group" aria-label="Quantity selector">
            <button class="qty-minus" aria-label="Decrease quantity" type="button">-</button>
            <span class="qty-value" aria-live="polite">1</span>
            <button class="qty-plus" aria-label="Increase quantity" type="button">+</button>
          </div>
          <button class="btn-add-to-cart flex-1" aria-label="Add {{ product.title }} to cart" type="button">Add to Cart</button>
        </div>
      </div>
    </article>
  {% endfor %}
</div>
